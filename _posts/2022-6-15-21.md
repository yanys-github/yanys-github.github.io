---
layout: post
title: JS执行机制
categories: 浏览器
author: yanys
---  

* content
{:toc}

- 变量提升
- JS代码的执行流程
- 执行上下文
- 调用栈
- 栈溢出




<!--more-->




## 变量提升
JS代码执行过程中，JS引擎把变量的声明部分和函数的声明部分提升到代码开头的“行为”，同时变量被提升后，会给变量设置默认值undefined。
## JS代码的执行流程
先编译，再执行。
### 编译阶段
在编译阶段，遇到**变量声明**时，JS引擎会在环境变量中创建该属性，并使用undefined对其初始化，  
 遇到**函数声明**时，JS引擎会在环境变量中创建该属性，并将函数定义存储到堆（HEAP）中，且属性指向堆中函数的位置。  

经过编译后，代码会生成两部分内容：**执行上下文和可执行代码**。其它代码（除声明），JS引擎将其编译为字节码，部分常用代码编译为二进制。    


> - **执行上下文**是JS执行代码时的运行环境，在执行上下文中存在一个变量环境对象，该对象中保存变量提升的内容。  


> 变量与函数同名处理原则: 
>
> - 如果是同名的函数，JS编译阶段会选择最后声明的那个。
> - 如果变量与函数同名，那么在编译阶段变量声明会覆盖变量声明，但之后执行阶段变量赋值会覆盖函数声明。



> - 变量和函数在声明时，在代码的位置不会改变，只是JS引擎将其放入到内存中。



### 执行阶段
JS执行可执行代码，并在变量环境中查找自定义的变量和函数。  
若进行赋值操作，则更新到执行上下文中的变量环境属性中。

## 执行上下文
- 当JS执行全局代码时，会编译全局代码并创建**全局执行上下文**，并且在整个页面的生存周期内，全局执行上下文只有一份。

- 当调用一个函数时，函数体内 代码会被编译，并创建函数执行上下文，一般情况下，函数执行结束后，创建的函数执行上下文会被销毁

- 使用eval()函数的时候，eval的代码也会被编译，并创建执行上下文

## 调用栈（执行上下文栈）
调用栈是JS引擎**追踪函数执行**的一个机制，当一次有多个函数被调用时，通过调用栈就能够追踪到哪个函数正在被执行以及各函数之间的调用关系。

**详情**
1. 在执行JS时，每调用一个函数，JavaScript 引擎会为其创建执行上下文(所以调用函数可能会存在多个执行上下文)，并把该执行上下文压入调用栈， 然后 JavaScript 引擎开始执行函数代码。
1. 如果在一个函数 A 中调用了另外一个函数 B，那么 JavaScript 引擎会为 B 函数创建执行上下文，并将 B 函数的执行上下文压入栈顶。
1. 当前函数执行完毕后，JavaScript 引擎会将该函数的执行上下文弹出栈。     



> **函数调用**是运行一个函数，具体使用方式是使用函数名成跟着一对小括号。

## 栈溢出
调用栈是有大小的，当入栈的执行上下文超过一定数目，JavaScript 引擎就会报错，我们把这种错误叫做**栈溢出**。

**解决方法:** 

把**递归调用**的形式改造成其他形式，或者使用加入定时器的方法来把当前任务拆分为其他很多小任务。
